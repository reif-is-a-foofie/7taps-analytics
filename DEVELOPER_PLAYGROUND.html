<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7taps Analytics - Developer Playground</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h3 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .endpoint {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            margin: 5px 0;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ 7taps Analytics Developer Playground</h1>
        <p>Quick access to common operations and API testing</p>
        <div>
            <a href="/docs" class="btn" target="_blank">üìö Full API Documentation</a>
            <a href="/dashboard" class="btn btn-secondary" target="_blank">üìä Dashboard</a>
            <a href="/ui/db-terminal" class="btn btn-secondary" target="_blank">üóÑÔ∏è Database Terminal</a>
        </div>
    </div>

    <div class="container">
        <!-- System Status -->
        <div class="card full-width">
            <h3>üîç System Status</h3>
            <div id="system-status">
                <button class="btn" onclick="checkHealth()">Check System Health</button>
                <button class="btn" onclick="checkDatabase()">Check Database</button>
                <button class="btn" onclick="checkETL()">Check ETL Status</button>
            </div>
            <div id="status-results"></div>
        </div>

        <!-- Data Import -->
        <div class="card">
            <h3>üì• Data Import</h3>
            <p>Import focus group data and other sources</p>
            <button class="btn" onclick="showFocusGroupTemplate()">Focus Group Template</button>
            <button class="btn" onclick="importFocusGroup()">Import Focus Group Data</button>
            <button class="btn" onclick="checkImportStats()">Import Statistics</button>
            <div id="import-results"></div>
        </div>

        <!-- Database Queries -->
        <div class="card">
            <h3>üóÑÔ∏è Database Queries</h3>
            <p>Quick database operations and analytics</p>
            <button class="btn" onclick="runPrebuiltQuery('user_engagement')">User Engagement</button>
            <button class="btn" onclick="runPrebuiltQuery('recent_activity')">Recent Activity</button>
            <button class="btn" onclick="runPrebuiltQuery('completion_trends')">Completion Trends</button>
            <button class="btn" onclick="showCustomQuery()">Custom Query</button>
            <div id="query-results"></div>
        </div>

        <!-- Analytics -->
        <div class="card">
            <h3>üìä Analytics</h3>
            <p>Analytics and reporting endpoints</p>
            <button class="btn" onclick="getCohortAnalytics()">Cohort Analytics</button>
            <button class="btn" onclick="getDashboardMetrics()">Dashboard Metrics</button>
            <button class="btn" onclick="getActivityData()">Activity Data</button>
            <div id="analytics-results"></div>
        </div>

        <!-- xAPI Operations -->
        <div class="card">
            <h3>üì° xAPI Operations</h3>
            <p>xAPI statement ingestion and management</p>
            <button class="btn" onclick="testXAPIIngestion()">Test xAPI Ingestion</button>
            <button class="btn" onclick="getXAPIStats()">xAPI Statistics</button>
            <button class="btn" onclick="showXAPITemplate()">xAPI Template</button>
            <div id="xapi-results"></div>
        </div>

        <!-- Data Normalization -->
        <div class="card">
            <h3>üîÑ Data Normalization</h3>
            <p>ETL and data processing operations</p>
            <button class="btn" onclick="checkNormalizationStats()">Normalization Stats</button>
            <button class="btn" onclick="triggerMigration()">Trigger Migration</button>
            <button class="btn" onclick="checkMigrationStatus()">Migration Status</button>
            <div id="normalization-results"></div>
        </div>

        <!-- Quick Examples -->
        <div class="card full-width">
            <h3>üí° Quick Examples</h3>
            <div class="grid-3">
                <div>
                    <h4>Check Focus Group Data</h4>
                    <div class="endpoint">GET /api/import/focus-group/template</div>
                    <button class="btn" onclick="checkFocusGroupTemplate()">Try It</button>
                </div>
                <div>
                    <h4>Query Database</h4>
                    <div class="endpoint">POST /ui/db-query</div>
                    <button class="btn" onclick="runExampleQuery()">Try It</button>
                </div>
                <div>
                    <h4>System Health</h4>
                    <div class="endpoint">GET /health</div>
                    <button class="btn" onclick="checkHealth()">Try It</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://seventaps-analytics-5135b3a0701a.herokuapp.com';

        async function makeRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    const error = await response.text();
                    return { success: false, error: error };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function showResult(elementId, result, title = 'Result') {
            const element = document.getElementById(elementId);
            const statusClass = result.success ? 'success' : 'error';
            const content = result.success ? 
                `<pre>${JSON.stringify(result.data, null, 2)}</pre>` :
                `<pre>Error: ${result.error}</pre>`;
            
            element.innerHTML = `
                <div class="status ${statusClass}">
                    <strong>${title}</strong>
                    ${content}
                </div>
            `;
        }

        // System Status Functions
        async function checkHealth() {
            const result = await makeRequest('/health');
            showResult('status-results', result, 'System Health');
        }

        async function checkDatabase() {
            const result = await makeRequest('/health/database');
            showResult('status-results', result, 'Database Health');
        }

        async function checkETL() {
            const result = await makeRequest('/ui/etl-status');
            showResult('status-results', result, 'ETL Status');
        }

        // Data Import Functions
        async function showFocusGroupTemplate() {
            const result = await makeRequest('/api/import/focus-group/template');
            showResult('import-results', result, 'Focus Group Template');
        }

        async function importFocusGroup() {
            showResult('import-results', { 
                success: true, 
                data: { message: 'Use the API endpoint POST /api/import/focus-group with CSV data' }
            }, 'Import Focus Group Data');
        }

        async function checkImportStats() {
            const result = await makeRequest('/api/import/stats');
            showResult('import-results', result, 'Import Statistics');
        }

        // Database Query Functions
        async function runPrebuiltQuery(queryType) {
            const queries = {
                user_engagement: "SELECT LOWER(actor_id) as learner, COUNT(*) as responses FROM statements_normalized WHERE context_extensions::text LIKE '%focus_group_import%' GROUP BY LOWER(actor_id) ORDER BY responses DESC LIMIT 10",
                recent_activity: "SELECT * FROM statements_normalized ORDER BY timestamp DESC LIMIT 5",
                completion_trends: "SELECT verb_id, COUNT(*) as count FROM statements_normalized GROUP BY verb_id ORDER BY count DESC"
            };
            
            const result = await makeRequest('/ui/db-query', {
                method: 'POST',
                body: JSON.stringify({ query: queries[queryType] })
            });
            showResult('query-results', result, `${queryType.replace('_', ' ').toUpperCase()} Query`);
        }

        async function showCustomQuery() {
            showResult('query-results', { 
                success: true, 
                data: { 
                    message: 'Use POST /ui/db-query with your SQL query',
                    example: { query: "SELECT COUNT(*) FROM statements_normalized" }
                }
            }, 'Custom Query');
        }

        // Analytics Functions
        async function getCohortAnalytics() {
            const result = await makeRequest('/api/analytics/cohorts');
            showResult('analytics-results', result, 'Cohort Analytics');
        }

        async function getDashboardMetrics() {
            const result = await makeRequest('/api/dashboard/metrics');
            showResult('analytics-results', result, 'Dashboard Metrics');
        }

        async function getActivityData() {
            const result = await makeRequest('/api/dashboard/activity');
            showResult('analytics-results', result, 'Activity Data');
        }

        // xAPI Functions
        async function testXAPIIngestion() {
            const result = await makeRequest('/ui/test-xapi-ingestion');
            showResult('xapi-results', result, 'xAPI Ingestion Test');
        }

        async function getXAPIStats() {
            const result = await makeRequest('/api/7taps/webhook-stats');
            showResult('xapi-results', result, 'xAPI Statistics');
        }

        async function showXAPITemplate() {
            showResult('xapi-results', { 
                success: true, 
                data: { 
                    message: 'Use POST /api/xapi/ingest with xAPI statement',
                    example: {
                        id: "test-statement-123",
                        actor: { objectType: "Agent", name: "John Doe" },
                        verb: { id: "http://adlnet.gov/expapi/verbs/completed" },
                        object: { id: "https://7taps.com/activities/test-course", objectType: "Activity" }
                    }
                }
            }, 'xAPI Template');
        }

        // Normalization Functions
        async function checkNormalizationStats() {
            const result = await makeRequest('/api/normalize/stats');
            showResult('normalization-results', result, 'Normalization Statistics');
        }

        async function triggerMigration() {
            const result = await makeRequest('/api/migration/trigger', {
                method: 'POST',
                body: JSON.stringify({ force: true })
            });
            showResult('normalization-results', result, 'Migration Trigger');
        }

        async function checkMigrationStatus() {
            const result = await makeRequest('/api/migration/status');
            showResult('normalization-results', result, 'Migration Status');
        }

        // Quick Examples
        async function checkFocusGroupTemplate() {
            const result = await makeRequest('/api/import/focus-group/template');
            showResult('status-results', result, 'Focus Group Template');
        }

        async function runExampleQuery() {
            const result = await makeRequest('/ui/db-query', {
                method: 'POST',
                body: JSON.stringify({ 
                    query: "SELECT COUNT(*) as total_statements FROM statements_normalized" 
                })
            });
            showResult('status-results', result, 'Example Query');
        }

        // Initialize page
        window.onload = function() {
            checkHealth();
        };
    </script>
</body>
</html>
