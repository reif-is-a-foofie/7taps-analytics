{% extends "base.html" %}

{% block title %}User Matching{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ðŸ”— User Matching</h1>
        <p class="text-gray-600">Match orphaned statements (statements without matched users) to existing users</p>
    </div>

    <!-- Summary Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Orphaned Statements</h2>
                <p class="text-sm text-gray-500 mt-1">Statements that couldn't be automatically matched to a user</p>
            </div>
            <div class="text-right">
                <p class="text-3xl font-bold text-orange-600" id="orphanedCount">-</p>
                <p class="text-sm text-gray-500">unmatched</p>
            </div>
        </div>
    </div>

    <!-- Orphaned Statements List -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="mb-4">
            <h2 class="text-xl font-semibold text-gray-900">Orphaned Statements</h2>
            <p class="text-sm text-gray-500">Select a user from the dropdown to match each statement</p>
        </div>
        
        <div id="orphanedStatements" class="space-y-4">
            <div class="text-center text-gray-500 py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2">Loading orphaned statements...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const orphanedStatements = document.getElementById('orphanedStatements');
    let allUsers = [];

    // Load orphaned statements and users
    async function loadData() {
        try {
            const response = await fetch('/ui/user-matching/data');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('orphanedCount').textContent = data.orphaned_count || 0;
                allUsers = data.users || [];
                renderOrphanedStatements(data.orphaned_statements || []);
            } else {
                showError('Failed to load data: ' + data.message);
            }
        } catch (error) {
            showError('Error loading data: ' + error.message);
        }
    }

    function renderOrphanedStatements(statements) {
        if (!statements || statements.length === 0) {
            orphanedStatements.innerHTML = '<p class="text-gray-500 text-center py-8">âœ… No orphaned statements found. All statements are matched!</p>';
            return;
        }

        orphanedStatements.innerHTML = statements.map(stmt => `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors" data-statement-id="${stmt.statement_id}">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm font-medium text-gray-900">${stmt.actor_name}</span>
                            <span class="text-xs text-gray-500">â€¢</span>
                            <span class="text-sm text-gray-600">${stmt.verb}</span>
                            <span class="text-xs text-gray-500">â€¢</span>
                            <span class="text-xs text-gray-500">${new Date(stmt.timestamp).toLocaleString()}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-1">${stmt.object_name}</p>
                        ${stmt.response ? `<p class="text-xs text-gray-500 italic">"${stmt.response}"</p>` : ''}
                        <p class="text-xs text-gray-400 mt-2">ID: ${stmt.statement_id.substring(0, 20)}...</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select class="user-select border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                data-statement-id="${stmt.statement_id}">
                            <option value="">Select user...</option>
                            ${allUsers.map(user => `
                                <option value="${user.user_id}">${user.display_name}</option>
                            `).join('')}
                        </select>
                        <button class="match-btn px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                data-statement-id="${stmt.statement_id}"
                                disabled>
                            Match
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        // Add event listeners
        document.querySelectorAll('.user-select').forEach(select => {
            select.addEventListener('change', function() {
                const statementId = this.dataset.statementId;
                const matchBtn = document.querySelector(`.match-btn[data-statement-id="${statementId}"]`);
                matchBtn.disabled = !this.value;
            });
        });

        document.querySelectorAll('.match-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const statementId = this.dataset.statementId;
                const select = document.querySelector(`.user-select[data-statement-id="${statementId}"]`);
                const userId = select.value;
                
                if (!userId) {
                    alert('Please select a user first');
                    return;
                }
                
                await matchStatement(statementId, userId);
            });
        });
    }

    async function matchStatement(statementId, userId) {
        const btn = document.querySelector(`.match-btn[data-statement-id="${statementId}"]`);
        const originalText = btn.textContent;
        
        btn.disabled = true;
        btn.textContent = 'Matching...';
        
        try {
            const response = await fetch('/ui/user-matching/match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    statement_id: statementId,
                    user_id: userId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove the matched statement from the list
                const statementDiv = document.querySelector(`[data-statement-id="${statementId}"]`);
                if (statementDiv) {
                    statementDiv.remove();
                }
                
                // Update count
                const currentCount = parseInt(document.getElementById('orphanedCount').textContent) || 0;
                document.getElementById('orphanedCount').textContent = Math.max(0, currentCount - 1);
                
                showSuccess('Statement matched successfully!');
            } else {
                showError('Match failed: ' + result.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (error) {
            showError('Error: ' + error.message);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    function showSuccess(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-md shadow-lg z-50';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    function showError(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-md shadow-lg z-50';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Load data on page load
    loadData();
    
    // Refresh data every 30 seconds
    setInterval(loadData, 30000);
});
</script>
{% endblock %}
