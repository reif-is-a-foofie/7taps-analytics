{% extends "base.html" %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6366f1;
        --bg-color: #ffffff;
        --card-bg: #f8fafc;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --success-color: #10b981;
        --danger-color: #ef4444;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-color);
        color: var(--text-primary);
        line-height: 1.6;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .header h1 {
        color: var(--primary-color);
        font-size: 2rem;
        font-weight: 600;
    }
    
    .nav-links {
        display: flex;
        gap: 1rem;
    }
    
    .nav-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        transition: all 0.2s;
    }
    
    .nav-link:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .control-group label {
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .control-group select,
    .control-group input {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        background: var(--bg-color);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-primary:hover {
        background: #5855eb;
    }
    
    .btn-secondary {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
        background: #e2e8f0;
    }
    
    .data-table {
        background: var(--bg-color);
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .table-header {
        background: var(--card-bg);
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .table-header h3 {
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    
    th {
        background: var(--card-bg);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9rem;
    }
    
    td {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    tr:hover {
        background: #f1f5f9;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }
    
    .error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .success {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #16a34a;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .filter-section {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .filter-section h3 {
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .filter-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: end;
    }
    
    .filter-controls select[multiple] {
        min-height: 120px;
        max-height: 200px;
        background: linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                    linear-gradient(-45deg, #f8fafc 25%, transparent 25%), 
                    linear-gradient(45deg, transparent 75%, #f8fafc 75%), 
                    linear-gradient(-45deg, transparent 75%, #f8fafc 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }
    
    .filter-controls select[multiple]:focus {
        background: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .multiselect-hint {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        font-style: italic;
    }
    
    .filter-controls input[type="date"] {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .filter-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }
    
    .active-filters {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="header">
            <h1>Data Explorer</h1>
            <div class="nav-links">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/chat" class="nav-link">Chat</a>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="table-select">Data Table:</label>
                <select id="table-select" onchange="loadTable()">
                    <option value="">Choose a table...</option>
                    <option value="user_responses">User Responses</option>
                    <option value="user_activities">User Activities</option>
                    <option value="users">Users</option>
                    <option value="lessons">Lessons</option>
                    <option value="questions">Questions</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="limit-input">Max Results:</label>
                <input type="number" id="limit-input" value="100" min="1" max="1000" onchange="loadTable()">
            </div>
        </div>
        
        <div class="filter-section">
            <h3>Quick Filters</h3>
            <div class="filter-controls">
                <div class="control-group">
                    <label for="lesson-filter">Lessons:</label>
                    <select id="lesson-filter" multiple onchange="applyFilters()">
                        <option value="">Loading lessons...</option>
                    </select>
                    <div class="multiselect-hint">Hold Ctrl/Cmd to select multiple</div>
                </div>
                
                <div class="control-group">
                    <label for="user-filter">Users:</label>
                    <select id="user-filter" multiple onchange="applyFilters()">
                        <option value="">Loading users...</option>
                    </select>
                    <div class="multiselect-hint">Hold Ctrl/Cmd to select multiple</div>
                </div>
                
                <div class="control-group">
                    <label for="activity-filter">Activity Type:</label>
                    <select id="activity-filter" multiple onchange="applyFilters()">
                        <option value="">Loading activities...</option>
                    </select>
                    <div class="multiselect-hint">Hold Ctrl/Cmd to select multiple</div>
                </div>
                
                <div class="control-group">
                    <label for="date-filter">Date Range:</label>
                    <input type="date" id="date-from" placeholder="From" onchange="applyFilters()">
                    <input type="date" id="date-to" placeholder="To" onchange="applyFilters()">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                <span id="active-filters" class="active-filters"></span>
            </div>
        </div>
        
        <div id="data-container">
            <div class="loading">Select a table to explore data</div>
        </div>
    </div>
    
    <script>
        let currentTable = '';
        let currentData = [];
        let currentColumns = [];
        
        async function loadTable() {
            const tableSelect = document.getElementById('table-select');
            const limitInput = document.getElementById('limit-input');
            const dataContainer = document.getElementById('data-container');
            
            const table = tableSelect.value;
            const limit = parseInt(limitInput.value) || 100;
            
            if (!table) {
                dataContainer.innerHTML = '<div class="error">Please select a table</div>';
                return;
            }
            
            currentTable = table;
            dataContainer.innerHTML = '<div class="loading">Loading table data...</div>';
            
            try {
                const response = await fetch(`/api/data-explorer/table/${table}?limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    currentData = data.data;
                    currentColumns = data.columns;
                    displayTableData(data.data, data.columns, data.total_rows);
                    loadFilterOptions(table);
                } else {
                    dataContainer.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                dataContainer.innerHTML = `<div class="error">Error loading table: ${error.message}</div>`;
            }
        }
        
        async function loadFilterOptions(table) {
            // Load lessons
            try {
                const lessonsResponse = await fetch('/api/data-explorer/lessons');
                const lessonsData = await lessonsResponse.json();
                if (lessonsData.success) {
                    populateLessonFilter(lessonsData.lessons);
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
            }
            
            // Load users
            try {
                const usersResponse = await fetch('/api/data-explorer/users');
                const usersData = await usersResponse.json();
                if (usersData.success) {
                    populateUserFilter(usersData.users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
            
            // Load activity types from current data
            if (currentData.length > 0) {
                populateActivityFilter();
            }
        }
        
        function populateLessonFilter(lessons) {
            const lessonFilter = document.getElementById('lesson-filter');
            lessonFilter.innerHTML = '<option value="">All Lessons</option>';
            
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = lesson.name;
                lessonFilter.appendChild(option);
            });
        }
        
        function populateUserFilter(users) {
            const userFilter = document.getElementById('user-filter');
            userFilter.innerHTML = '<option value="">All Users</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.display_name || user.email || `User ${user.id}`;
                userFilter.appendChild(option);
            });
        }
        
        function populateActivityFilter() {
            const activityFilter = document.getElementById('activity-filter');
            activityFilter.innerHTML = '<option value="">All Activities</option>';
            
            // Extract unique activity types from current data
            const activityTypes = new Set();
            currentData.forEach(row => {
                if (row.activity_type) {
                    activityTypes.add(row.activity_type);
                }
            });
            
            Array.from(activityTypes).sort().forEach(activityType => {
                const option = document.createElement('option');
                option.value = activityType;
                option.textContent = activityType;
                activityFilter.appendChild(option);
            });
        }
        
        async function applyFilters() {
            if (!currentTable) return;
            
            const lessonFilter = document.getElementById('lesson-filter');
            const userFilter = document.getElementById('user-filter');
            const activityFilter = document.getElementById('activity-filter');
            const dateFrom = document.getElementById('date-from');
            const dateTo = document.getElementById('date-to');
            
            const selectedLessons = Array.from(lessonFilter.selectedOptions).map(opt => opt.value).filter(v => v);
            const selectedUsers = Array.from(userFilter.selectedOptions).map(opt => opt.value).filter(v => v);
            const selectedActivities = Array.from(activityFilter.selectedOptions).map(opt => opt.value).filter(v => v);
            
            // Build filter URL
            let url = `/api/data-explorer/table/${currentTable}/filtered?limit=1000`;
            
            if (selectedLessons.length > 0) {
                url += `&lesson_ids=${selectedLessons.join(',')}`;
            }
            if (selectedUsers.length > 0) {
                url += `&user_ids=${selectedUsers.join(',')}`;
            }
            
            const dataContainer = document.getElementById('data-container');
            dataContainer.innerHTML = '<div class="loading">Applying filters...</div>';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    let filteredData = data.data;
                    
                    // Apply client-side filters for activity type and date range
                    if (selectedActivities.length > 0) {
                        filteredData = filteredData.filter(row => 
                            row.activity_type && selectedActivities.includes(row.activity_type)
                        );
                    }
                    
                    if (dateFrom.value || dateTo.value) {
                        filteredData = filteredData.filter(row => {
                            if (!row.created_at) return true;
                            const rowDate = new Date(row.created_at);
                            const fromDate = dateFrom.value ? new Date(dateFrom.value) : null;
                            const toDate = dateTo.value ? new Date(dateTo.value) : null;
                            
                            if (fromDate && rowDate < fromDate) return false;
                            if (toDate && rowDate > toDate) return false;
                            return true;
                        });
                    }
                    
                    displayTableData(filteredData, currentColumns, filteredData.length);
                    updateActiveFilters();
                } else {
                    dataContainer.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                dataContainer.innerHTML = `<div class="error">Error applying filters: ${error.message}</div>`;
            }
        }
        
        function updateActiveFilters() {
            const lessonFilter = document.getElementById('lesson-filter');
            const userFilter = document.getElementById('user-filter');
            const activityFilter = document.getElementById('activity-filter');
            const dateFrom = document.getElementById('date-from');
            const dateTo = document.getElementById('date-to');
            
            const activeFilters = [];
            
            if (lessonFilter.selectedOptions.length > 0) {
                const selectedLessons = Array.from(lessonFilter.selectedOptions)
                    .filter(opt => opt.value !== '')
                    .map(opt => opt.textContent);
                if (selectedLessons.length > 0) {
                    const display = selectedLessons.length > 2 ? 
                        `${selectedLessons.slice(0, 2).join(', ')} +${selectedLessons.length - 2} more` : 
                        selectedLessons.join(', ');
                    activeFilters.push(`Lessons: ${display}`);
                }
            }
            
            if (userFilter.selectedOptions.length > 0) {
                const selectedUsers = Array.from(userFilter.selectedOptions)
                    .filter(opt => opt.value !== '')
                    .map(opt => opt.textContent);
                if (selectedUsers.length > 0) {
                    const display = selectedUsers.length > 2 ? 
                        `${selectedUsers.slice(0, 2).join(', ')} +${selectedUsers.length - 2} more` : 
                        selectedUsers.join(', ');
                    activeFilters.push(`Users: ${display}`);
                }
            }
            
            if (activityFilter.selectedOptions.length > 0) {
                const selectedActivities = Array.from(activityFilter.selectedOptions)
                    .filter(opt => opt.value !== '')
                    .map(opt => opt.textContent);
                if (selectedActivities.length > 0) {
                    const display = selectedActivities.length > 2 ? 
                        `${selectedActivities.slice(0, 2).join(', ')} +${selectedActivities.length - 2} more` : 
                        selectedActivities.join(', ');
                    activeFilters.push(`Activities: ${display}`);
                }
            }
            
            if (dateFrom.value || dateTo.value) {
                const dateRange = [];
                if (dateFrom.value) dateRange.push(`From: ${dateFrom.value}`);
                if (dateTo.value) dateRange.push(`To: ${dateTo.value}`);
                activeFilters.push(`Date: ${dateRange.join(' - ')}`);
            }
            
            const activeFiltersSpan = document.getElementById('active-filters');
            activeFiltersSpan.textContent = activeFilters.length > 0 ? 
                `Active Filters: ${activeFilters.join(' | ')}` : 
                'No filters applied';
        }
        
        function clearFilters() {
            document.getElementById('lesson-filter').selectedIndex = -1;
            document.getElementById('user-filter').selectedIndex = -1;
            document.getElementById('activity-filter').selectedIndex = -1;
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            
            // Reload original data
            if (currentTable) {
                loadTable();
            }
        }
        
        function displayTableData(rows, columns, totalCount) {
            const dataContainer = document.getElementById('data-container');
            
            if (!rows || rows.length === 0) {
                dataContainer.innerHTML = '<div class="success">No data found</div>';
                return;
            }
            
            let tableHtml = `
                <div class="data-table">
                    <div class="table-header">
                        <h3>Data (${rows.length} rows)</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
            `;
            
            // Add column headers
            columns.forEach(column => {
                tableHtml += `<th>${column}</th>`;
            });
            
            tableHtml += `
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Add data rows
            rows.forEach(row => {
                tableHtml += '<tr>';
                columns.forEach(column => {
                    const value = row[column];
                    let displayValue = value;
                    
                    if (value === null || value === undefined) {
                        displayValue = '<em>null</em>';
                    } else if (typeof value === 'object') {
                        displayValue = JSON.stringify(value);
                    } else if (typeof value === 'string' && value.length > 50) {
                        displayValue = value.substring(0, 50) + '...';
                    }
                    
                    tableHtml += `<td>${displayValue}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            dataContainer.innerHTML = tableHtml;
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            // Load initial table list
            const dataContainer = document.getElementById('data-container');
            dataContainer.innerHTML = '<div class="success">Select a table to explore data</div>';
        });
    </script>
{% endblock %}
